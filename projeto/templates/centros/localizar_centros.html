{% extends "base.html" %}
{% block title %}Mapa de Centros{% endblock %}

{% load static %}
{% block css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{% static 'centros.css' %}">
{% endblock css %}

{% block content %}
    <div style="display: flex; flex-direction: column; align-items: center;">
        <h1>Centros de Reciclagem</h1>
        
        <!-- entrada do endere√ßo -->
        <form style="margin-bottom: 20px; display: flex; align-items: center;" method="POST" action="{% url 'centros:calcular_distancia' %}">
            {% csrf_token %}
            <input type="text" id="user_address" name="user_address" placeholder="Digite seu endere√ßo" required style="padding-top: 15px; border-radius: 5px; width: 500px; flex-shrink: 0;">
            <button type="submit" style="padding: 5px; margin-left: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background-color: #d3d3d3; border: none; border-radius: 5px;">
                üîç
            </button>
        </form>
              
        
        <div style="display: flex; gap: 20px;">
            <div id="map" style="margin-top: 15px; height: 500px; width: 500px; border-radius: 15px;"></div>
            
            <div>
                {% if centros_com_distancia %}
                    <ul>
                        {% for item in centros_com_distancia %}
                            <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <strong style="margin-bottom: 5px; display: inline-block;">{{ item.centro.nome }}</strong><br>
                                    <b style="margin-bottom: 4px; display: inline-block;">Endere√ßo:</b> {{ item.centro.endereco }}, {{ item.centro.numero }} {{ item.centro.complemento }}
                                </div>
                                <p style="color: green; margin-left: 20px;">{{ item.distancia }} km de dist√¢ncia</p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhum centro de coleta cadastrado.</p>
                {% endif %}
            </div>
        </div>
    </div>

{% endblock content %}
{% block scripts %}
    <script>
        var latitude = -8.0587;  // Latitude da Rua do Bom Jesus, Recife
        var longitude = -34.8769; // Longitude da Rua do Bom Jesus, Recife
        var map = L.map('map').setView([latitude, longitude], 13); // Defina o centro do mapa

        // Substitua 'SUA_CHAVE_API' pela sua chave da API Geoapify
        L.tileLayer('https://maps.geoapify.com/v1/tile/carto/{z}/{x}/{y}.png?&apiKey=fe9dcd1706f6496a8c40b70dcd0cdde6', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fun√ß√£o para carregar os pontos de coleta
        function loadPontosDeColeta() {
            console.log("Carregando pontos de coleta..."); 
            fetch('/centros/pontos-de-coleta/')
            .then(response => response.json())
            .then(data => {
                console.log(data); // Verifique os dados retornados
                var pontos = data.pontos;

                pontos.forEach(function(ponto) {
                    if (ponto.latitude && ponto.longitude) {
                        var lat = parseFloat(ponto.latitude);
                        var lon = parseFloat(ponto.longitude);
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup('<b>' + ponto.nome + '</b><br>' + ponto.endereco);
                    } else {
                        console.log('Coordenadas inv√°lidas para o ponto:', ponto.nome);
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao carregar os pontos de coleta:', error);
            });
        }

        // Carregar os pontos de coleta ao carregar o mapa
        loadPontosDeColeta();
    </script>
{% endblock scripts %}
